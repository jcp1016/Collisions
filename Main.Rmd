---
title: "NYC Collisions"
output: html_document
---

This is a work in progress.

```{r, echo=TRUE}
#library("Cairo")
library("dplyr")
library("ggplot2")
library("gpclib")
library("RColorBrewer")
library("rgdal")
library("sqldf")
library("rgeos")
library("graphics")
library("grDevices")
library("grid")

setwd(".")
rawdata <- read.csv("./DATA/NYPD_Motor_Vehicle_Collisions-2014.csv", header=TRUE)
names(rawdata)[4] <- "ZIP"
data <- sqldf("select ZIP, count(*) as 'Collisions', sum(`NUMBER.OF.PERSONS.KILLED`) as 'Fatalities', sum(`NUMBER.OF.CYCLIST.KILLED`) as 'BicycleFatalities', sum(`NUMBER.OF.CYCLIST.INJURED`) as 'BicycleInjuries' from rawdata where BOROUGH = 'MANHATTAN' group by ZIP")
```

Get map  

```{r, echo=TRUE}
setwd("./zip_codes_shp")
zipmap <- readOGR(dsn=".","PostalBoundary")
zipmap_nyc <- zipmap[zipmap$POSTAL %in% factor(data$ZIP),]
setwd("../")
```

Merge map with data by ZIP

```{r, echo=TRUE}
zipmap_nyc_df <- fortify(zipmap_nyc)
map_data <- data.frame(id=rownames(zipmap_nyc@data), ZIP=zipmap_nyc@data$POSTAL)
map_data <- merge(map_data, data, by="ZIP")
map_df   <- merge(zipmap_nyc_df, map_data, by="id")

map_df$CollisionRange <- cut(map_df$Collisions, breaks=quantile(map_df$Collisions), dig.lab=4, include.lowest=TRUE)
map_df$BInjuryRange <- cut(map_df$BicycleInjuries, breaks=quantile(map_df$BicycleInjuries), dig.lab=3, include.lowest=TRUE)
```

Make plots

```{r, echo=TRUE}

p1 <- ggplot(map_df) + aes(x=long, y=lat, group = group, fill=CollisionRange) + geom_polygon() + geom_path(color="white") + ggtitle("Manhattan Collisions - 2014") + xlab(NULL) + ylab(NULL) + coord_equal() + scale_fill_brewer("Number of Collisions (Range)") + theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())

p2 <- ggplot(map_df) + aes(x=long, y=lat, group = group, fill=factor(Fatalities)) + geom_polygon() + geom_path(color="white") + ggtitle("Fatalities") + xlab(NULL) +  ylab(NULL) + coord_equal() + scale_fill_brewer("Number of Fatalities from Collisions - 2014") + theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())

p3 <- ggplot(map_df) + aes(x=long, y=lat, group = group, fill=factor(BicycleFatalities)) + geom_polygon() + geom_path(color="white") + ggtitle("Cyclists Killed in Collisions - 2014") + xlab(NULL) +  ylab(NULL) + coord_equal() + scale_fill_brewer("Number Killed") + theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())

p4 <- ggplot(map_df) + aes(x=long, y=lat, group = group, fill=BInjuryRange) + geom_polygon() + geom_path(color="white") + ggtitle("Cyclists Injuried in Collisions - 2014") + xlab(NULL) +  ylab(NULL) + coord_equal() + scale_fill_brewer("Number Injured (Range)") + theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())
```

Save to svg files

```{r, echo=FALSE}
#svg(filename = "AllCollisionsPlot.svg", width = 7, height = 7, onefile = TRUE, pointsize = 12, family = "sans", bg = "white", antialias = c("default", "none", "gray", "subpixel"))
#print(p1)

#svg(filename = "FatalitiesPlot.svg", width = 7, height = 7, onefile = TRUE, pointsize = 12, family = "sans", bg = "white", antialias = c("default", "none", "gray", "subpixel"))
#print(p2)

#svg(filename = "BikeFatalitiesPlot.svg", width = 7, height = 7, onefile = TRUE, pointsize = 12, family = "sans", bg = "white", antialias = c("default", "none", "gray", "subpixel"))
#print(p3)

#svg(filename = "BikeInjuriesPlot.svg", width = 7, height = 7, onefile = TRUE, pointsize = 12, family = "sans", bg = "white", antialias = c("default", "none", "gray", "subpixel"))
#print(p4)

#dev.off()
```

Show plots

```{r, echo=FALSE}
print(p1)
print(p2)
print(p3)
print(p4)
```

```{r, echo=TRUE}
```
